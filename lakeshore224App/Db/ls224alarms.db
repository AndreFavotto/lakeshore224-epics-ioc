#######################################################
# DB file for Lakeshore 224 Alarms
# Reading strategy adapted from Lakeshore 336 IOC, by Matt Pearson - DLS
#####################################################
#macros: 
#DEVICE: Device name (PV prefix)
#INPUTS ={A, B, C1-C5, D1-D5} 
#PORT = communication bus ID
######################################################

## NOTE: the last part of the record name is hard coded into protocol file. 

################################# ALARMS #################################

# Alarm reading Trig
record(stringin, "$(DEVICE)Alrm$(INPUT)-RB") {
  field(DESC, "Read Alarm Params")
  field(DTYP, "stream")
  field(INP, "@ls224.proto getALARM($(INPUT),$(DEVICE)Alrm$(INPUT)) $(PORT)")
  field(SCAN, "1 second")
}
#The alarm reading records below are filled by protocol file
record(bi, "$(DEVICE)Alrm$(INPUT)OnOff-RB") {
  field(DESC, "Alarm Enabled")
  field(ZNAM, "Disabled")
  field(ONAM, "Enabled")
}
record(ai, "$(DEVICE)Alrm$(INPUT)HighVal-RB") {
  field(DESC, "Alarm High Value")
}
record(ai, "$(DEVICE)Alrm$(INPUT)LowVal-RB") {
  field(DESC, "Alarm Low Value")
}
record(ai, "$(DEVICE)Alrm$(INPUT)DeadBand-RB") {
  field(DESC, "Alarm Deadband")
}
record(bi, "$(DEVICE)Alrm$(INPUT)LatchEnbl-RB") {
  field(DESC, "Alarm Latch Enable")
  field(ZNAM, "Non Latching")
  field(ONAM, "Latching")
}
record(bi, "$(DEVICE)Alrm$(INPUT)Audible-RB") {
  field(DESC, "Alarm Audible through internal speaker")
  field(ZNAM, "Quiet")
  field(ONAM, "Audible")
}
record(bi, "$(DEVICE)Alrm$(INPUT)Visible-RB") {
  field(DESC, "Alarm visible through front panel led")
  field(ZNAM, "Non Visible")
  field(ONAM, "Visible")
}

# Alarm setting

record(bo, "$(DEVICE)Alrm$(INPUT)OnOff-Cmd") {
  field(DESC, "Enable or disable alarm")
  field(OUT,  "@ls224.proto setAlarmOnOff($(INPUT),$(DEVICE)Alrm$(INPUT)) $(PORT)")
}
record(ao, "$(DEVICE)Alrm$(INPUT)HighVal-SP") {
  field(DESC, "Set Alarm High Value")
  field(OUT,  "@ls224.proto setAlarmHighVal($(INPUT),$(DEVICE)Alrm$(INPUT)) $(PORT)")
}
record(ao, "$(DEVICE)Alrm$(INPUT)LowVal-SP") {
  field(DESC, "Set Alarm Low Value")
  field(OUT,  "@ls224.proto setAlarmLowVal($(INPUT),$(DEVICE)Alrm$(INPUT)) $(PORT)")
}
record(ao, "$(DEVICE)Alrm$(INPUT)DeadBand") {
  field(DESC, "Set Alarm Deadband")
  field(OUT,  "@ls224.proto setAlarmDeadBand($(INPUT),$(DEVICE)Alrm$(INPUT)) $(PORT)")
}
record(bo, "$(DEVICE)Alrm$(INPUT)LatchEnbl-Cmd") {
  field(DESC, "Set Alarm Latch Enable")
  field(OUT,  "@ls224.proto setAlarmLatchEnable($(INPUT),$(DEVICE)Alrm$(INPUT)) $(PORT)")
}
record(bo, "$(DEVICE)Alrm$(INPUT)Audible-Cmd") {
  field(DESC, "Define if alarm is audible through internal speaker")
  field(OUT,  "@ls224.proto setAlarmAudible($(INPUT),$(DEVICE)Alrm$(INPUT)) $(PORT)")
}
record(bo, "$(DEVICE)Alrm$(INPUT)Visible-Cmd") {
  field(DESC, "Define if alarm is visible through front panel led")
  field(OUT,  "@ls224.proto setAlarmVisible($(INPUT),$(DEVICE)Alrm$(INPUT)) $(PORT)")
}

################################# RELAY 1 #################################

# Relay reading
record(stringin, "$(DEVICE)Relay1Status-Mon"){
  field(DESC, "get relay 1 general status")
  field(DTYP, "stream")
  field(INP, "@ls224.proto getRelay(1, $(DEVICE)Relay1) $(PORT)")
  field(SCAN, "1 second")
}

record(mbbi, "$(DEVICE)Relay1Mode-Sts") {
  field(DESC, "get relay 1 operation mode")
  field(ZRVL, "0")
  field(ZRST, "Off")        
  field(ONVL, "1")
  field(ONST, "On")         
  field(TWVL, "2")
  field(TWST, "Alarms")         
}

record(stringin, "$(DEVICE)Relay1InpTrig-Sts") {
  field(DESC, "get relay 1 input Trig")
}

record(mbbi, "$(DEVICE)Relay1AlrmType-Sts") {
  field(DESC, "get alarm type that triggers relay")
  field(ZRVL, "0")
  field(ZRST, "Low alarm")        
  field(ONVL, "1")
  field(ONST, "High alarm")         
  field(TWVL, "2")
  field(TWST, "Both alarms")         
}

# Relay writing

record(mbbo, "$(DEVICE)Relay1Mode-Sel") {
  field(DESC, "set relay 1 operation mode")
  field(OUT,  "@ls224.proto setRelayMode(1, $(DEVICE)Relay1) $(PORT)")         
  field(ZRVL, "0")
  field(ZRST, "Off")        
  field(ONVL, "1")
  field(ONST, "On")         
  field(TWVL, "2")
  field(TWST, "Alarms")
}

record(stringout, "$(DEVICE)Relay1InpTrig-Sel") {
  field(DESC, "set relay 2 input trigger")
  field(OUT,  "@ls224.proto setRelayInpTrigger(1, $(DEVICE)Relay1) $(PORT)")
}

record(mbbo, "$(DEVICE)Relay1AlrmType-Sel") {
  field(DESC, "set relay 1 alarm type")
  field(OUT,  "@ls224.proto setRelayMode(1, $(DEVICE)Relay1) $(PORT)")         
  field(ZRVL, "0")
  field(ZRST, "Low alarm")        
  field(ONVL, "1")
  field(ONST, "High alarm")         
  field(TWVL, "2")
  field(TWST, "Both alarms")
}

###################### RELAY 2 ######################

# Relay reading
record(stringin, "$(DEVICE)Relay2Status-Mon"){
  field(DESC, "get relay 2 general status")
  field(DTYP, "stream")
  field(INP, "@ls224.proto getRelay(2, $(DEVICE)Relay2) $(PORT)")
  field(SCAN, "1 second")
}

record(mbbi, "$(DEVICE)Relay2Mode-Sts") {
  field(DESC, "get relay 2 operation mode")
  field(ZRVL, "0")
  field(ZRST, "Off")        
  field(ONVL, "1")
  field(ONST, "On")         
  field(TWVL, "2")
  field(TWST, "Alarms")         
}

record(stringin, "$(DEVICE)Relay2InpTrig-Sts") {
  field(DESC, "get relay 2 input Trig")
}

record(mbbi, "$(DEVICE)Relay2AlrmType-Sts") {
  field(DESC, "get alarm type that Trigs relay")
  field(ZRVL, "0")
  field(ZRST, "Low alarm")        
  field(ONVL, "1")
  field(ONST, "High alarm")         
  field(TWVL, "2")
  field(TWST, "Both alarms")         
}

# Relay writing

record(mbbo, "$(DEVICE)Relay2Mode-Sts") {
  field(DESC, "set relay 2 operation mode")
  field(OUT,  "@ls224.proto setRelayMode(2, $(DEVICE)Relay2) $(PORT)")         
  field(ZRVL, "0")
  field(ZRST, "Off")        
  field(ONVL, "1")
  field(ONST, "On")         
  field(TWVL, "2")
  field(TWST, "Alarms")
}

record(stringout, "$(DEVICE)Relay2InpTrig-Sts") {
  field(DESC, "set relay 2 input Trig")
  field(OUT,  "@ls224.proto setRelayInpTrig(2, $(DEVICE)Relay2) $(PORT)")
}

record(mbbo, "$(DEVICE)Relay2AlarmType-Sts") {
  field(DESC, "set relay 1 alarm type")
  field(OUT,  "@ls224.proto setRelayMode(2, $(DEVICE)Relay2) $(PORT)")         
  field(ZRVL, "0")
  field(ZRST, "Low alarm")        
  field(ONVL, "1")
  field(ONST, "High alarm")         
  field(TWVL, "2")
  field(TWST, "Both alarms")
}